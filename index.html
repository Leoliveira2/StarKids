<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SuperKids - Plataforma Educacional Gamificada</title>
    <meta name="description" content="Transforme tarefas em aventuras divertidas para crian√ßas de 5 a 12 anos">
    
    <!-- PWA Meta Tags Otimizados para iPad -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SuperKids">
    <meta name="theme-color" content="#3B82F6">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            --safe-area-inset-right: env(safe-area-inset-right);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
            padding-left: var(--safe-area-inset-left);
            padding-right: var(--safe-area-inset-right);
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        /* Touch optimizations for iPad */
        .touch-optimized {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        button, .button {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            min-width: 44px;
        }

        input, select, textarea {
            font-size: 16px !important;
            -webkit-appearance: none;
            border-radius: 12px;
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .touch-feedback {
            transform: scale(1);
            transition: transform 0.1s ease-out;
        }

        .touch-feedback:active {
            transform: scale(0.95);
        }

        /* Mascot animations */
        @keyframes dance {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(8deg) scale(1.05); }
            50% { transform: rotate(0deg) scale(1); }
            75% { transform: rotate(-8deg) scale(1.05); }
            100% { transform: rotate(0deg) scale(1); }
        }
        
        .dance {
            animation: dance 1s ease-in-out;
            display: inline-block;
            will-change: transform;
        }

        @keyframes warrior-dance {
            0% { transform: scale(1) rotate(0deg); }
            20% { transform: scale(1.15) rotate(12deg); }
            40% { transform: scale(1.08) rotate(-8deg); }
            60% { transform: scale(1.2) rotate(15deg); }
            80% { transform: scale(1.08) rotate(-12deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        .warrior-dance {
            animation: warrior-dance 1.2s ease-in-out;
            display: inline-block;
            will-change: transform;
        }

        @keyframes warrior-active {
            0% { transform: scale(1); filter: brightness(1) drop-shadow(0 0 0px rgba(255,215,0,0)); }
            25% { transform: scale(1.08); filter: brightness(1.1) drop-shadow(0 0 8px rgba(255,215,0,0.6)); }
            50% { transform: scale(1.12); filter: brightness(1.2) drop-shadow(0 0 12px rgba(255,215,0,0.8)); }
            75% { transform: scale(1.08); filter: brightness(1.1) drop-shadow(0 0 8px rgba(255,215,0,0.6)); }
            100% { transform: scale(1); filter: brightness(1) drop-shadow(0 0 0px rgba(255,215,0,0)); }
        }
        
        .warrior-active {
            animation: warrior-active 0.8s ease-in-out infinite;
            display: inline-block;
            will-change: transform, filter;
        }

        /* Central reward animations */
        @keyframes reward-popup {
            0% { 
                transform: translate(-50%, -50%) scale(0) rotate(0deg); 
                opacity: 0; 
            }
            20% { 
                transform: translate(-50%, -50%) scale(1.6) rotate(180deg); 
                opacity: 1; 
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.3) rotate(360deg); 
                opacity: 1; 
            }
            80% { 
                transform: translate(-50%, -50%) scale(1.4) rotate(540deg); 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(0.6) rotate(720deg); 
                opacity: 0; 
            }
        }
        
        .reward-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            font-size: min(15vw, 120px);
            animation: reward-popup 2.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            pointer-events: none;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.9);
            will-change: transform, opacity;
        }

        @keyframes xp-fly {
            0% { 
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            20% { 
                transform: translate(-50%, -50%) scale(1.3);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -85vh) scale(0.9);
                opacity: 0;
            }
        }
        
        .xp-fly {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9998;
            font-size: min(8vw, 48px);
            font-weight: bold;
            color: #f59e0b;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.6);
            animation: xp-fly 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            pointer-events: none;
            will-change: transform, opacity;
        }

        @keyframes screen-flash {
            0% { background: rgba(255, 255, 255, 0); }
            50% { background: rgba(255, 215, 0, 0.4); }
            100% { background: rgba(255, 255, 255, 0); }
        }
        
        .screen-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9997;
            pointer-events: none;
            animation: screen-flash 0.6s ease-out;
        }

        @keyframes central-confetti {
            0% { 
                transform: translate(-50%, -50%) scale(0) rotate(0deg);
                opacity: 1;
            }
            15% { 
                transform: translate(-50%, -50%) scale(1.2) rotate(180deg);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) translateX(var(--random-x)) translateY(-100vh) scale(0.6) rotate(720deg);
                opacity: 0;
            }
        }
        
        .central-confetti {
            position: fixed;
            top: 50%;
            left: 50%;
            z-index: 9996;
            font-size: min(6vw, 36px);
            animation: central-confetti 3.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            pointer-events: none;
            will-change: transform, opacity;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-6px); }
            80% { transform: translateX(6px); }
        }
        
        .shake {
            animation: shake 0.6s ease-in-out;
        }

        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 100%;
            animation: progress-gradient 3s ease infinite;
        }

        @keyframes progress-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .loading-ring {
            display: inline-block;
            position: relative;
            width: 60px;
            height: 60px;
        }

        .loading-ring div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 48px;
            height: 48px;
            margin: 6px;
            border: 6px solid #3b82f6;
            border-radius: 50%;
            animation: loading-ring-spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: #3b82f6 transparent transparent transparent;
        }

        .loading-ring div:nth-child(1) { animation-delay: -0.45s; }
        .loading-ring div:nth-child(2) { animation-delay: -0.3s; }
        .loading-ring div:nth-child(3) { animation-delay: -0.15s; }

        @keyframes loading-ring-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .bg-white {
                background-color: #1f2937 !important;
                color: white;
            }
            
            .text-gray-800 {
                color: #f9fafb !important;
            }
            
            .text-gray-600 {
                color: #d1d5db !important;
            }
        }

        /* Activity edit mode styles */
        .edit-mode {
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div id="app" class="touch-optimized"></div>

    <script>
        // Enhanced state management
        let appState = {
            currentUser: null,
            users: [],
            activities: [],
            showLogin: true,
            showAddActivity: false,
            showEditActivities: false,
            isLoading: false,
            lastUpdate: Date.now()
        };

        let loginForm = {
            name: '',
            type: 'child',
            mascot: 'star'
        };

        let activityForm = {
            name: '',
            description: '',
            points: 10,
            targetUserId: '',
            category: 'geral'
        };

        // Enhanced mascots with Chancho
        const mascots = {
            star: { name: 'Stella', emoji: '‚≠ê', danceClass: 'dance', description: 'A estrela guia que ilumina seu caminho' },
            dragon: { name: 'Drako', emoji: 'üêâ', danceClass: 'dance', description: 'O drag√£o s√°bio protetor das crian√ßas' },
            heart: { name: 'Cora√ß√£o', emoji: 'üíñ', danceClass: 'dance', description: 'O cora√ß√£o gentil cheio de amor' },
            chancho: { name: 'Chancho', emoji: 'üßíüèΩ', danceClass: 'warrior-dance', description: 'O pequeno guerreiro maia de 4 anos' },
            robot: { name: 'Robo', emoji: 'ü§ñ', danceClass: 'dance', description: 'O rob√¥ inteligente e divertido' },
            unicorn: { name: 'Uni', emoji: 'ü¶Ñ', danceClass: 'dance', description: 'O unic√≥rnio m√°gico dos sonhos' }
        };

        const motivationalMessages = [
            'Parab√©ns! Voc√™ est√° arrasando! ‚≠ê',
            'Que orgulho! Mais uma conquista! üéâ',
            'Uau! Voc√™ √© incr√≠vel! üí™',
            'Fant√°stico! Continue assim! üåü',
            'Voc√™ √© demais! Brilhando sempre! ‚ú®',
            'Incr√≠vel! Voc√™ √© um campe√£o! üèÜ',
            'Perfeito! Voc√™ est√° voando! üöÄ',
            'Sensacional! Que dedica√ß√£o! üíé',
            'Guerreiro(a)! Chancho ficaria orgulhoso! ‚öîÔ∏è',
            'For√ßa de guerreiro! Voc√™ √© imbat√≠vel! üõ°Ô∏è',
            'Estrela brilhante! Continue assim! üåü',
            'Que conquista √©pica! üéä'
        ];

        const achievements = [
            { id: 1, name: 'Primeiro Passo', description: 'Complete sua primeira atividade', points: 1, icon: 'üéØ', rarity: 'common' },
            { id: 2, name: 'Dedicado', description: 'Complete 3 atividades', points: 3, icon: 'üìö', rarity: 'common' },
            { id: 3, name: 'Super Estrela', description: 'Complete 5 atividades', points: 5, icon: '‚≠ê', rarity: 'rare' },
            { id: 4, name: 'Impar√°vel', description: 'Complete 10 atividades', points: 10, icon: 'üöÄ', rarity: 'rare' },
            { id: 5, name: 'Lenda', description: 'Complete 20 atividades', points: 20, icon: 'üëë', rarity: 'epic' },
            { id: 6, name: 'Mestre Supremo', description: 'Complete 50 atividades', points: 50, icon: 'üèÜ', rarity: 'legendary' }
        ];

        // 8 default activities as requested
        const defaultActivities = [
            { name: 'Dormir no hor√°rio', description: 'Ir para a cama no hor√°rio combinado', points: 15, category: 'sa√∫de' },
            { name: 'Escovar os dentes', description: 'Escova√ß√£o completa manh√£ e noite', points: 10, category: 'higiene' },
            { name: 'Fazer o dever de casa', description: 'Completar todas as tarefas escolares', points: 20, category: 'educa√ß√£o' },
            { name: 'Ler por 15 minutos', description: 'Momento de leitura di√°ria', points: 15, category: 'educa√ß√£o' },
            { name: 'Organizar o quarto', description: 'Guardar brinquedos e organizar espa√ßo', points: 10, category: 'responsabilidade' },
            { name: 'Tomar banho', description: 'Higiene pessoal completa', points: 10, category: 'higiene' },
            { name: 'Comer frutas/verduras', description: 'Alimenta√ß√£o saud√°vel', points: 10, category: 'alimenta√ß√£o' },
            { name: 'Ajudar em casa', description: 'Colaborar com as tarefas dom√©sticas', points: 15, category: 'responsabilidade' }
        ];

        // Device capabilities
        function detectDeviceCapabilities() {
            return {
                hasVibration: 'vibrate' in navigator,
                hasAudio: typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined',
                hasTouchscreen: 'ontouchstart' in window,
                isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
                isIPad: /iPad/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1),
                supportsLocalStorage: typeof Storage !== 'undefined'
            };
        }

        const deviceCaps = detectDeviceCapabilities();

        // Enhanced vibration
        function vibrateDevice(pattern = [200, 100, 200]) {
            if (!deviceCaps.hasVibration) return;
            
            try {
                navigator.vibrate(pattern);
            } catch (e) {
                console.log('Vibra√ß√£o n√£o suportada:', e);
            }
        }

        // Enhanced audio feedback
        function playSuccessSound(type = 'success') {
            if (!deviceCaps.hasAudio) return;
            
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                const audioContext = new AudioCtx();
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                const frequencies = {
                    success: [800, 1000, 1200],
                    achievement: [600, 800, 1000, 1200],
                    levelup: [500, 700, 900, 1100, 1300]
                };
                
                const freq = frequencies[type] || frequencies.success;
                
                freq.forEach((f, i) => {
                    setTimeout(() => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        
                        osc.frequency.value = f;
                        osc.type = 'sine';
                        
                        gain.gain.setValueAtTime(0, audioContext.currentTime);
                        gain.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        
                        osc.start(audioContext.currentTime);
                        osc.stop(audioContext.currentTime + 0.3);
                    }, i * 150);
                });
                
            } catch (e) {
                console.log('√Åudio n√£o suportado:', e);
            }
        }

        // Enhanced reward animation system
        function showRewardAnimation(mascotEmoji, points, isAchievement = false, achievementType = 'common') {
            // Screen flash
            const flash = document.createElement('div');
            flash.className = 'screen-flash';
            if (isAchievement) {
                flash.style.animationDuration = achievementType === 'legendary' ? '1s' : '0.6s';
            }
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), isAchievement ? 1000 : 600);

            // Central mascot popup
            const mascotPopup = document.createElement('div');
            mascotPopup.className = 'reward-popup';
            mascotPopup.textContent = isAchievement ? 'üèÜ' : mascotEmoji;
            document.body.appendChild(mascotPopup);
            setTimeout(() => mascotPopup.remove(), 2500);

            // XP flying animation
            if (points > 0) {
                setTimeout(() => {
                    const xpElement = document.createElement('div');
                    xpElement.className = 'xp-fly';
                    xpElement.textContent = '+' + points + ' XP!';
                    document.body.appendChild(xpElement);
                    setTimeout(() => xpElement.remove(), 2000);
                }, 500);
            }

            // Enhanced confetti
            setTimeout(() => {
                createCentralConfetti(isAchievement, achievementType);
            }, 200);

            // Audio feedback
            if (isAchievement) {
                playSuccessSound('achievement');
                vibrateDevice([200, 100, 200, 100, 400, 100, 200]);
            } else {
                playSuccessSound('success');
                vibrateDevice([100, 50, 100, 50, 200]);
            }
        }

        // Enhanced confetti with achievement tiers
        function createCentralConfetti(isAchievement = false, achievementType = 'common') {
            const confettiEmojis = ['üéâ', '‚≠ê', 'üåü', '‚ú®', 'üéä'];
            const currentMascot = appState.currentUser ? mascots[appState.currentUser.mascot] : null;
            
            if (currentMascot && appState.currentUser.mascot === 'chancho') {
                confettiEmojis.push('‚öîÔ∏è', 'üõ°Ô∏è', 'üí™', 'üî•');
            }

            if (isAchievement) {
                const tierEmojis = {
                    common: ['üèÜ', 'üéØ'],
                    rare: ['üèÜ', 'üëë', 'üíé'],
                    epic: ['üèÜ', 'üëë', 'üíé', 'üåà', 'üí´'],
                    legendary: ['üèÜ', 'üëë', 'üíé', 'üåà', 'üí´', 'üî•', '‚ö°', 'üåü']
                };
                confettiEmojis.push(...(tierEmojis[achievementType] || tierEmojis.common));
            }
            
            const confettiCount = isAchievement ? 
                (achievementType === 'legendary' ? 30 : achievementType === 'epic' ? 25 : 20) : 15;
            
            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'central-confetti';
                    confetti.textContent = confettiEmojis[Math.floor(Math.random() * confettiEmojis.length)];
                    
                    const randomX = (Math.random() - 0.5) * (deviceCaps.isIPad ? 600 : 400);
                    confetti.style.setProperty('--random-x', randomX + 'px');
                    confetti.style.animationDelay = Math.random() * 0.8 + 's';
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }, 3500);
                }, i * 40);
            }
        }

        // Utility functions
        function calculateLevel(xp) {
            return Math.floor(Math.sqrt(xp / 50)) + 1;
        }

        function getXpForNextLevel(xp) {
            const currentLevel = calculateLevel(xp);
            return Math.pow(currentLevel, 2) * 50 - xp;
        }

        function getTotalXpForLevel(level) {
            return Math.pow(level - 1, 2) * 50;
        }

        // Enhanced storage
        function saveToLocalStorage() {
            if (!deviceCaps.supportsLocalStorage) return false;
            
            try {
                const data = {
                    users: appState.users,
                    activities: appState.activities,
                    lastUpdate: appState.lastUpdate,
                    version: '2.0'
                };
                localStorage.setItem('superkids-data', JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('Erro ao salvar:', e);
                showNotification('Erro ao salvar dados', 'error');
                return false;
            }
        }

        function loadFromLocalStorage() {
            if (!deviceCaps.supportsLocalStorage) return false;
            
            try {
                const savedData = localStorage.getItem('superkids-data');
                if (!savedData) return false;

                const data = JSON.parse(savedData);
                if (data.version && data.users && data.activities) {
                    appState.users = data.users;
                    appState.activities = data.activities;
                    appState.lastUpdate = data.lastUpdate || Date.now();
                    return true;
                }
                return false;
            } catch (e) {
                console.error('Erro ao carregar:', e);
                return false;
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'success', duration = 4000) {
            const notification = document.createElement('div');
            const baseClasses = 'fixed top-4 right-4 z-50 p-4 rounded-xl shadow-lg text-white slide-up max-w-sm';
            const typeClasses = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notification.className = `${baseClasses} ${typeClasses[type] || typeClasses.info}`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-lg">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            if (type === 'success') {
                vibrateDevice([100, 50, 100]);
            } else if (type === 'error') {
                vibrateDevice([400]);
            }
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        // Create default activities for child
        function createDefaultActivitiesForChild(childId) {
            const today = new Date().toISOString();
            return defaultActivities.map((activity, index) => ({
                id: Date.now() + index,
                userId: childId,
                name: activity.name,
                description: activity.description,
                points: activity.points,
                category: activity.category,
                status: 'pending',
                date: today,
                createdAt: today,
                isDefault: true
            }));
        }

        // Enhanced achievement system
        function checkAchievements(user) {
            const completedActivities = appState.activities.filter(a => 
                a.userId === user.id && a.status === 'completed'
            ).length;

            const newAchievements = [];
            
            achievements.forEach(achievement => {
                if (user.achievements && user.achievements.includes(achievement.id)) return;
                
                if (completedActivities >= achievement.points) {
                    newAchievements.push(achievement);
                }
            });
            
            if (newAchievements.length > 0) {
                // Update user achievements
                appState.users = appState.users.map(u => 
                    u.id === user.id ? { 
                        ...u, 
                        achievements: [...(u.achievements || []), ...newAchievements.map(a => a.id)] 
                    } : u
                );
                
                if (appState.currentUser && appState.currentUser.id === user.id) {
                    appState.currentUser.achievements = [...(appState.currentUser.achievements || []), ...newAchievements.map(a => a.id)];
                }
                
                // Show achievements with delays
                newAchievements.forEach((achievement, index) => {
                    setTimeout(() => {
                        const mascotEmoji = mascots[user.mascot].emoji;
                        showRewardAnimation(mascotEmoji, 0, true, achievement.rarity);
                        
                        setTimeout(() => {
                            showNotification(`üèÜ Nova conquista: ${achievement.name}!`, 'success', 5000);
                        }, 1000);
                    }, index * 2000);
                });
                
                saveToLocalStorage();
            }
        }

        // Enhanced login system
        function handleLogin() {
            if (!loginForm.name.trim()) {
                showNotification('Por favor, digite seu nome!', 'error');
                const input = document.getElementById('login-name');
                if (input) {
                    input.classList.add('shake');
                    setTimeout(() => input.classList.remove('shake'), 600);
                }
                return;
            }

            appState.isLoading = true;
            render();

            setTimeout(() => {
                const existingUser = appState.users.find(u => 
                    u.name.toLowerCase().trim() === loginForm.name.toLowerCase().trim()
                );
                
                if (existingUser) {
                    appState.currentUser = existingUser;
                    showNotification(`Ol√° novamente, ${existingUser.name}! üòä`);
                } else {
                    const newUser = {
                        id: Date.now(),
                        name: loginForm.name.trim(),
                        type: loginForm.type,
                        xp: 0,
                        mascot: loginForm.mascot,
                        achievements: [],
                        createdAt: new Date().toISOString(),
                        streak: 0,
                        totalActivities: 0
                    };
                    
                    appState.users.push(newUser);
                    appState.currentUser = newUser;

                    if (newUser.type === 'child') {
                        const defaultActivitiesForChild = createDefaultActivitiesForChild(newUser.id);
                        appState.activities.push(...defaultActivitiesForChild);
                        showNotification(`Bem-vindo(a), ${newUser.name}! Suas 8 atividades foram criadas! üéâ`);
                    } else {
                        showNotification(`Bem-vindo(a), ${newUser.name}! üëã`);
                    }
                }

                appState.showLogin = false;
                appState.isLoading = false;
                saveToLocalStorage();
                render();
            }, 1000);
        }

        function selectUserType(type) {
            loginForm.type = type;
            render();
        }

        function selectMascot(mascot) {
            loginForm.mascot = mascot;
            render();
        }

        function logout() {
            appState.currentUser = null;
            appState.showLogin = true;
            appState.showEditActivities = false;
            loginForm = { name: '', type: 'child', mascot: 'star' };
            render();
        }

        // Enhanced activity completion
        function completeActivity(activityId) {
            const activity = appState.activities.find(a => a.id === activityId);
            if (!activity || activity.status === 'completed') return;

            // Update activity status
            appState.activities = appState.activities.map(a => 
                a.id === activityId ? { ...a, status: 'completed', completedAt: new Date().toISOString() } : a
            );

            // Update user XP and stats
            const user = appState.users.find(u => u.id === activity.userId);
            if (user) {
                const oldLevel = calculateLevel(user.xp);
                const newXp = user.xp + activity.points;
                const newLevel = calculateLevel(newXp);
                const leveledUp = newLevel > oldLevel;

                appState.users = appState.users.map(u => 
                    u.id === activity.userId ? { 
                        ...u, 
                        xp: newXp,
                        totalActivities: (u.totalActivities || 0) + 1
                    } : u
                );

                if (appState.currentUser && appState.currentUser.id === activity.userId) {
                    appState.currentUser.xp = newXp;
                    appState.currentUser.totalActivities = (appState.currentUser.totalActivities || 0) + 1;
                }

                // Enhanced visual feedback
                const activityElement = document.querySelector(`[data-activity-id="${activityId}"]`);
                if (activityElement) {
                    activityElement.classList.add('touch-feedback');
                    setTimeout(() => {
                        activityElement.style.transform = 'scale(1.05)';
                        activityElement.style.background = 'linear-gradient(135deg, #10b981, #34d399)';
                    }, 100);
                }

                // Main reward animation
                const mascotEmoji = mascots[user.mascot].emoji;
                showRewardAnimation(mascotEmoji, activity.points, false);

                // Level up animation if applicable
                if (leveledUp) {
                    setTimeout(() => {
                        showRewardAnimation('üéä', 0, true, 'rare');
                        showNotification(`üéä Subiu para o n√≠vel ${newLevel}!`, 'success', 6000);
                    }, 2000);
                }

                // Check achievements after a delay
                setTimeout(() => {
                    checkAchievements(user);
                }, 1500);

                // Success message
                const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
                setTimeout(() => {
                    showNotification(`${randomMessage} +${activity.points} XP!`);
                }, 800);

                saveToLocalStorage();
                
                // Re-render with delay to show animations
                setTimeout(() => {
                    render();
                }, 1200);
            }
        }

        function showAddActivityModal() {
            appState.showAddActivity = true;
            activityForm = { name: '', description: '', points: 10, targetUserId: '', category: 'geral' };
            render();
        }

        function hideAddActivityModal() {
            appState.showAddActivity = false;
            render();
        }

        function addActivity() {
            if (!activityForm.name.trim() || !activityForm.targetUserId) {
                showNotification('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            const activity = {
                id: Date.now(),
                userId: parseInt(activityForm.targetUserId),
                name: activityForm.name.trim(),
                description: activityForm.description.trim(),
                points: Math.max(1, Math.min(100, activityForm.points)),
                category: activityForm.category,
                status: 'pending',
                date: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                isDefault: false
            };

            appState.activities.push(activity);
            appState.showAddActivity = false;
            showNotification('Atividade adicionada! üéØ');
            saveToLocalStorage();
            render();
        }

        function fillActivitySuggestion(name, description, points, category) {
            activityForm.name = name;
            activityForm.description = description;
            activityForm.points = points;
            activityForm.category = category;
            render();
        }

        // Enhanced activity editing functions
        function toggleEditMode() {
            appState.showEditActivities = !appState.showEditActivities;
            render();
        }

        function editActivity(activityId, field, value) {
            appState.activities = appState.activities.map(a => 
                a.id === activityId ? { ...a, [field]: value } : a
            );
            saveToLocalStorage();
        }

        function deleteActivity(activityId) {
            if (confirm('Tem certeza que deseja excluir esta atividade?')) {
                appState.activities = appState.activities.filter(a => a.id !== activityId);
                showNotification('Atividade exclu√≠da!', 'warning');
                saveToLocalStorage();
                render();
            }
        }

        // Enhanced render function
        function render() {
            try {
                const app = document.getElementById('app');
                if (!app) return;

                requestAnimationFrame(() => {
                    if (appState.showLogin || !appState.currentUser) {
                        app.innerHTML = LoginScreen();
                    } else if (appState.currentUser.type === 'child') {
                        app.innerHTML = ChildDashboard();
                    } else {
                        app.innerHTML = ParentDashboard();
                    }

                    setupInputListeners();
                });
            } catch (e) {
                console.error('Erro no render:', e);
                showNotification('Erro na interface', 'error');
            }
        }

        function setupInputListeners() {
            const inputs = [
                { id: 'login-name', property: 'name', form: loginForm },
                { id: 'activity-name', property: 'name', form: activityForm },
                { id: 'activity-description', property: 'description', form: activityForm },
                { id: 'activity-points', property: 'points', form: activityForm, isNumber: true },
                { id: 'activity-target', property: 'targetUserId', form: activityForm },
                { id: 'activity-category', property: 'category', form: activityForm }
            ];

            inputs.forEach(({ id, property, form, isNumber }) => {
                const element = document.getElementById(id);
                if (element) {
                    let timeout;
                    element.addEventListener('input', (e) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            form[property] = isNumber ? 
                                (parseInt(e.target.value) || 10) : 
                                e.target.value;
                        }, 100);
                    });
                }
            });
        }

        // Enhanced component functions
        function LoginScreen() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 flex items-center justify-center p-6">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full fade-in">
                        <div class="text-center mb-8">
                            <h1 class="text-5xl font-bold text-gray-800 mb-3">SuperKids</h1>
                            <p class="text-gray-600 text-lg">Sua aventura de aprendizado come√ßa aqui!</p>
                        </div>

                        ${appState.isLoading ? `
                            <div class="text-center py-8">
                                <div class="loading-ring mx-auto">
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                </div>
                                <p class="text-gray-600 mt-4 text-lg">Preparando sua aventura...</p>
                            </div>
                        ` : `
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                                    <input
                                        type="text"
                                        id="login-name"
                                        placeholder="Digite seu nome"
                                        value="${loginForm.name}"
                                        class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:outline-none transition-all duration-300 text-lg touch-feedback"
                                    />
                                </div>

                                <div class="space-y-3">
                                    <label class="block text-sm font-medium text-gray-700">Voc√™ √©:</label>
                                    <div class="grid grid-cols-2 gap-4">
                                        <button
                                            onclick="selectUserType('child')"
                                            class="p-4 rounded-xl border-2 transition-all duration-300 touch-feedback ${
                                                loginForm.type === 'child' ? 'border-blue-400 bg-blue-50 shadow-lg' : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                            }"
                                        >
                                            <div class="text-3xl mb-2">üë∂</div>
                                            <div class="font-medium">Crian√ßa</div>
                                        </button>
                                        <button
                                            onclick="selectUserType('parent')"
                                            class="p-4 rounded-xl border-2 transition-all duration-300 touch-feedback ${
                                                loginForm.type === 'parent' ? 'border-blue-400 bg-blue-50 shadow-lg' : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                            }"
                                        >
                                            <div class="text-3xl mb-2">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                                            <div class="font-medium">Respons√°vel</div>
                                        </button>
                                    </div>
                                </div>

                                ${loginForm.type === 'child' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-3">Escolha seu mascote:</label>
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            ${Object.entries(mascots).map(([key, mascot]) => `
                                                <button
                                                    onclick="selectMascot('${key}')"
                                                    class="p-4 rounded-xl border-2 transition-all duration-300 touch-feedback ${
                                                        loginForm.mascot === key ? 'border-blue-400 bg-blue-50 shadow-lg' : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                                    }"
                                                >
                                                    <div class="text-3xl mb-2 ${loginForm.mascot === key ? mascot.danceClass : ''}">${mascot.emoji}</div>
                                                    <div class="text-sm font-medium">${mascot.name}</div>
                                                    <div class="text-xs text-gray-500 mt-1 text-center">${mascot.description}</div>
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}

                                <button
                                    onclick="handleLogin()"
                                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-xl font-bold text-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-300 touch-feedback shadow-lg"
                                >
                                    üöÄ Entrar na Aventura
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function ChildDashboard() {
            const userActivities = appState.activities.filter(a => a.userId === appState.currentUser.id);
            const todayActivities = userActivities.filter(a => 
                new Date(a.date).toDateString() === new Date().toDateString()
            );
            const completedToday = todayActivities.filter(a => a.status === 'completed').length;
            const totalToday = todayActivities.length;
            const currentMascot = mascots[appState.currentUser.mascot];
            const completedTotal = userActivities.filter(a => a.status === 'completed').length;
            const currentLevel = calculateLevel(appState.currentUser.xp);
            const xpForNext = getXpForNextLevel(appState.currentUser.xp);
            const progressPercent = totalToday > 0 ? (completedToday / totalToday) * 100 : 0;
            const levelProgressPercent = ((appState.currentUser.xp - getTotalXpForLevel(currentLevel)) / (getTotalXpForLevel(currentLevel + 1) - getTotalXpForLevel(currentLevel))) * 100;

            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 p-4 relative">
                    <div class="max-w-6xl mx-auto">
                        <!-- Enhanced Header -->
                        <div class="bg-white rounded-3xl shadow-xl p-6 mb-6 fade-in">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center space-x-4">
                                    <div class="text-5xl ${
                                        appState.currentUser.mascot === 'chancho' 
                                            ? (completedToday > 0 ? 'warrior-active' : '') 
                                            : (completedToday > 0 ? 'dance' : '')
                                    }">${currentMascot.emoji}</div>
                                    <div>
                                        <h1 class="text-3xl font-bold text-gray-800">
                                            ${appState.currentUser.mascot === 'chancho' ? '‚öîÔ∏è ' : ''}Ol√°, ${appState.currentUser.name}!
                                        </h1>
                                        <p class="text-gray-600 text-lg">
                                            ${currentMascot.description}
                                        </p>
                                    </div>
                                </div>
                                <button onclick="logout()" class="text-gray-500 hover:text-gray-700 p-3 rounded-xl hover:bg-gray-100 transition-all duration-300 touch-feedback">
                                    <span class="text-2xl">‚Ü©Ô∏è</span>
                                </button>
                            </div>

                            <!-- Enhanced Stats Grid -->
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="bg-gradient-to-br from-yellow-100 to-yellow-200 p-6 rounded-2xl text-center shadow-lg">
                                    <div class="text-3xl mb-3">‚ö°</div>
                                    <div class="text-3xl font-bold text-yellow-800">${appState.currentUser.xp}</div>
                                    <div class="text-sm text-yellow-600 font-medium">XP Total</div>
                                </div>
                                <div class="bg-gradient-to-br from-blue-100 to-blue-200 p-6 rounded-2xl text-center shadow-lg">
                                    <div class="text-3xl mb-3">üéØ</div>
                                    <div class="text-3xl font-bold text-blue-800">${currentLevel}</div>
                                    <div class="text-sm text-blue-600 font-medium">N√≠vel</div>
                                </div>
                                <div class="bg-gradient-to-br from-green-100 to-green-200 p-6 rounded-2xl text-center shadow-lg">
                                    <div class="text-3xl mb-3">‚úÖ</div>
                                    <div class="text-3xl font-bold text-green-800">${completedTotal}</div>
                                    <div class="text-sm text-green-600 font-medium">Conclu√≠das</div>
                                </div>
                                <div class="bg-gradient-to-br from-purple-100 to-purple-200 p-6 rounded-2xl text-center shadow-lg">
                                    <div class="text-3xl mb-3">üèÜ</div>
                                    <div class="text-3xl font-bold text-purple-800">${(appState.currentUser.achievements || []).length}</div>
                                    <div class="text-sm text-purple-600 font-medium">Conquistas</div>
                                </div>
                            </div>

                            <!-- Enhanced Progress Section -->
                            <div class="mt-6 space-y-4">
                                <div class="p-4 bg-gray-50 rounded-2xl">
                                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                                        <span class="font-medium">Pr√≥ximo n√≠vel</span>
                                        <span class="font-bold">Faltam ${xpForNext} XP</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div 
                                            class="progress-bar h-3 rounded-full transition-all duration-1000"
                                            style="width: ${Math.max(5, levelProgressPercent)}%"
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Activities Section -->
                        <div class="bg-white rounded-3xl shadow-xl p-6 mb-6 slide-up">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">üìã Minhas Atividades de Hoje</h2>
                                <div class="text-lg font-bold text-gray-600">${completedToday}/${totalToday}</div>
                            </div>
                            
                            <div class="mb-6">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span class="font-medium">Progresso do dia</span>
                                    <span class="font-bold">${Math.round(progressPercent)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4">
                                    <div 
                                        class="progress-bar h-4 rounded-full transition-all duration-1000"
                                        style="width: ${Math.max(5, progressPercent)}%"
                                    ></div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                ${todayActivities.length === 0 ? `
                                    <div class="text-center py-12">
                                        <div class="text-6xl mb-4">üéØ</div>
                                        <h3 class="text-xl font-bold text-gray-700 mb-2">Nenhuma atividade para hoje</h3>
                                        <p class="text-gray-500">Que tal pedir para seus pais adicionarem algumas atividades divertidas?</p>
                                    </div>
                                ` : todayActivities.map(activity => `
                                    <div class="p-5 rounded-2xl border-2 transition-all duration-300 ${
                                        activity.status === 'completed' ? 
                                        'bg-gradient-to-r from-green-50 to-emerald-50 border-green-200 shadow-lg' : 
                                        'bg-gray-50 border-gray-200 hover:border-gray-300 hover:shadow-md'
                                    } fade-in relative" data-activity-id="${activity.id}">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <h3 class="font-bold text-gray-800 text-lg mb-1">${activity.name}</h3>
                                                <p class="text-gray-600 mb-3">${activity.description}</p>
                                                <div class="flex items-center space-x-3">
                                                    <div class="flex items-center space-x-1">
                                                        <span class="text-yellow-500 text-lg">‚ö°</span>
                                                        <span class="font-bold text-yellow-600">${activity.points} XP</span>
                                                    </div>
                                                    ${activity.category && activity.category !== 'geral' ? `
                                                        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs font-medium">${activity.category}</span>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            ${activity.status === 'pending' ? `
                                                <button
                                                    onclick="completeActivity(${activity.id})"
                                                    class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all duration-300 font-bold text-lg touch-feedback shadow-lg ml-4"
                                                >
                                                    ‚úì Concluir
                                                </button>
                                            ` : `
                                                <div class="text-green-600 font-bold flex items-center space-x-2 ml-4">
                                                    <span class="text-2xl">‚úÖ</span>
                                                    <span class="text-lg">Conclu√≠da!</span>
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Enhanced Achievements Section -->
                        ${(appState.currentUser.achievements || []).length > 0 ? `
                            <div class="bg-white rounded-3xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-6">üèÜ Suas Conquistas</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    ${achievements.filter(a => (appState.currentUser.achievements || []).includes(a.id)).map(achievement => `
                                        <div class="p-6 rounded-2xl bg-gradient-to-br from-yellow-50 to-orange-50 border-2 border-yellow-200 fade-in shadow-lg">
                                            <div class="flex items-center space-x-4">
                                                <div class="text-4xl">${achievement.icon}</div>
                                                <div>
                                                    <h3 class="font-bold text-yellow-800 text-lg">${achievement.name}</h3>
                                                    <p class="text-yellow-600 mb-2">${achievement.description}</p>
                                                    <span class="px-2 py-1 bg-yellow-200 text-yellow-800 rounded-lg text-xs font-bold uppercase">${achievement.rarity}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function ParentDashboard() {
            const childUsers = appState.users.filter(u => u.type === 'child');

            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 p-4">
                    <div class="max-w-7xl mx-auto">
                        <!-- Enhanced Header -->
                        <div class="bg-white rounded-3xl shadow-xl p-6 mb-6 fade-in">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Painel dos Respons√°veis</h1>
                                    <p class="text-gray-600 text-lg">Acompanhe e gerencie as atividades das crian√ßas</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button
                                        onclick="showAddActivityModal()"
                                        class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-xl hover:from-blue-600 hover:to-purple-700 flex items-center space-x-2 transition-all duration-300 touch-feedback shadow-lg font-bold"
                                    >
                                        <span class="text-lg">‚ûï</span>
                                        <span>Nova Atividade</span>
                                    </button>
                                    ${childUsers.length > 0 ? `
                                        <button
                                            onclick="toggleEditMode()"
                                            class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-6 py-3 rounded-xl hover:from-orange-600 hover:to-red-700 flex items-center space-x-2 transition-all duration-300 touch-feedback shadow-lg font-bold"
                                        >
                                            <span class="text-lg">‚úèÔ∏è</span>
                                            <span>${appState.showEditActivities ? 'Sair do Modo Edi√ß√£o' : 'Editar Atividades'}</span>
                                        </button>
                                    ` : ''}
                                    <button
                                        onclick="logout()"
                                        class="text-gray-500 hover:text-gray-700 p-3 rounded-xl hover:bg-gray-100 transition-all duration-300 touch-feedback"
                                    >
                                        <span class="text-2xl">‚Ü©Ô∏è</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        ${appState.showEditActivities ? EditActivitiesSection() : ''}

                        <!-- Enhanced Children Overview -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                            ${childUsers.map(child => {
                                const childActivities = appState.activities.filter(a => a.userId === child.id);
                                const completedActivities = childActivities.filter(a => a.status === 'completed');
                                const todayActivities = childActivities.filter(a => 
                                    new Date(a.date).toDateString() === new Date().toDateString()
                                );
                                const completedToday = todayActivities.filter(a => a.status === 'completed').length;
                                const mascot = mascots[child.mascot];
                                const currentLevel = calculateLevel(child.xp);
                                const progressPercent = todayActivities.length > 0 ? (completedToday / todayActivities.length) * 100 : 0;
                                
                                return `
                                    <div class="bg-white rounded-3xl shadow-xl p-6 slide-up hover:shadow-2xl transition-all duration-300">
                                        <div class="flex items-center space-x-4 mb-6">
                                            <div class="text-4xl ${
                                                child.mascot === 'chancho' 
                                                    ? (completedToday > 0 ? 'warrior-active' : '') 
                                                    : (completedToday > 0 ? 'dance' : '')
                                            }">${mascot.emoji}</div>
                                            <div>
                                                <h3 class="font-bold text-gray-800 text-xl">
                                                    ${child.mascot === 'chancho' ? '‚öîÔ∏è ' : ''}${child.name}
                                                </h3>
                                                <p class="text-gray-600">
                                                    N√≠vel ${currentLevel} ‚Ä¢ ${mascot.name}
                                                    ${child.mascot === 'chancho' ? ' üõ°Ô∏è' : ''}
                                                </p>
                                            </div>
                                        </div>
                                        
                                        <div class="space-y-3 mb-6">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">XP Total:</span>
                                                <span class="font-bold text-yellow-600">${child.xp} ‚ö°</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Hoje:</span>
                                                <span class="font-bold text-green-600">${completedToday}/${todayActivities.length}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Total conclu√≠das:</span>
                                                <span class="font-bold text-blue-600">${completedActivities.length}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Conquistas:</span>
                                                <span class="font-bold text-purple-600">${(child.achievements || []).length} üèÜ</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Enhanced Progress Visualization -->
                                        <div>
                                            <div class="flex justify-between text-sm text-gray-500 mb-2">
                                                <span class="font-medium">Progresso de hoje</span>
                                                <span class="font-bold">${Math.round(progressPercent)}%</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-3">
                                                <div 
                                                    class="progress-bar h-3 rounded-full transition-all duration-1000"
                                                    style="width: ${Math.max(5, progressPercent)}%"
                                                ></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            
                            ${childUsers.length === 0 ? `
                                <div class="col-span-full bg-white rounded-3xl shadow-xl p-12 text-center">
                                    <div class="text-6xl mb-6">üë∂</div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-3">Nenhuma crian√ßa cadastrada</h3>
                                    <p class="text-gray-600 text-lg">Pe√ßa para as crian√ßas se cadastrarem primeiro!</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Enhanced Add Activity Modal -->
                    ${appState.showAddActivity ? AddActivityModal() : ''}
                </div>
            `;
        }

        function EditActivitiesSection() {
            const childUsers = appState.users.filter(u => u.type === 'child');
            
            return `
                <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">‚úèÔ∏è Editar Atividades das Crian√ßas</h2>
                    
                    ${childUsers.map(child => {
                        const childActivities = appState.activities.filter(a => a.userId === child.id);
                        const mascot = mascots[child.mascot];
                        
                        return `
                            <div class="mb-8 p-6 bg-gray-50 rounded-2xl">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="text-3xl">${mascot.emoji}</div>
                                    <h3 class="text-xl font-bold text-gray-800">${child.name}</h3>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${childActivities.map(activity => `
                                        <div class="relative p-4 bg-white rounded-xl border-2 edit-mode">
                                            <button 
                                                onclick="deleteActivity(${activity.id})"
                                                class="delete-btn"
                                            >√ó</button>
                                            
                                            <div class="space-y-3">
                                                <input
                                                    type="text"
                                                    value="${activity.name}"
                                                    onchange="editActivity(${activity.id}, 'name', this.value)"
                                                    class="w-full font-bold text-gray-800 bg-transparent border-b border-gray-300 focus:border-blue-500 focus:outline-none"
                                                />
                                                <textarea
                                                    onchange="editActivity(${activity.id}, 'description', this.value)"
                                                    class="w-full text-gray-600 bg-transparent border-b border-gray-300 focus:border-blue-500 focus:outline-none resize-none"
                                                    rows="2"
                                                >${activity.description}</textarea>
                                                <div class="flex items-center space-x-4">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="text-yellow-500">‚ö°</span>
                                                        <input
                                                            type="number"
                                                            value="${activity.points}"
                                                            onchange="editActivity(${activity.id}, 'points', parseInt(this.value) || 10)"
                                                            class="w-16 bg-transparent border-b border-gray-300 focus:border-blue-500 focus:outline-none"
                                                            min="1"
                                                            max="100"
                                                        />
                                                        <span class="text-yellow-600 text-sm">XP</span>
                                                    </div>
                                                    <select
                                                        onchange="editActivity(${activity.id}, 'category', this.value)"
                                                        class="bg-transparent border-b border-gray-300 focus:border-blue-500 focus:outline-none text-sm"
                                                    >
                                                        <option value="geral" ${activity.category === 'geral' ? 'selected' : ''}>Geral</option>
                                                        <option value="sa√∫de" ${activity.category === 'sa√∫de' ? 'selected' : ''}>Sa√∫de</option>
                                                        <option value="higiene" ${activity.category === 'higiene' ? 'selected' : ''}>Higiene</option>
                                                        <option value="educa√ß√£o" ${activity.category === 'educa√ß√£o' ? 'selected' : ''}>Educa√ß√£o</option>
                                                        <option value="alimenta√ß√£o" ${activity.category === 'alimenta√ß√£o' ? 'selected' : ''}>Alimenta√ß√£o</option>
                                                        <option value="responsabilidade" ${activity.category === 'responsabilidade' ? 'selected' : ''}>Responsabilidade</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function AddActivityModal() {
            const childUsers = appState.users.filter(u => u.type === 'child');
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in">
                    <div class="bg-white rounded-3xl p-8 max-w-lg w-full slide-up modal-content">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">‚ûï Nova Atividade</h2>
                        <div class="space-y-6">
                            ${childUsers.length > 0 ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Crian√ßa</label>
                                    <select
                                        id="activity-target"
                                        value="${activityForm.targetUserId}"
                                        class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:outline-none transition-all duration-300 text-lg"
                                    >
                                        <option value="">üë∂ Selecione a crian√ßa</option>
                                        ${childUsers.map(child => `
                                            <option value="${child.id}">${child.name} ${mascots[child.mascot].emoji}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            ` : `
                                <div class="p-6 bg-red-50 border-2 border-red-200 rounded-xl text-center">
                                    <div class="text-red-800 font-bold text-lg">Nenhuma crian√ßa cadastrada</div>
                                    <div class="text-red-600 mt-2">Pe√ßa para as crian√ßas se cadastrarem primeiro</div>
                                </div>
                            `}
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome da atividade *</label>
                                <input
                                    type="text"
                                    id="activity-name"
                                    placeholder="üìù Ex: Fazer o dever de casa"
                                    value="${activityForm.name}"
                                    class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:outline-none transition-all duration-300 text-lg"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                                <textarea
                                    id="activity-description"
                                    placeholder="üìã Descreva a atividade..."
                                    value="${activityForm.description}"
                                    class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:outline-none transition-all duration-300 text-lg resize-none"
                                    rows="3"
                                ></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Pontos XP (1-100)</label>
                                    <input
                                        type="number"
                                        id="activity-points"
                                        placeholder="‚ö° XP"
                                        value="${activityForm.points}"
                                        class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:outline-none transition-all duration-300 text-lg"
                                        min="1"
                                        max="100"
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                                    <select
                                        id="activity-category"
                                        value="${activityForm.category}"
                                        class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:outline-none transition-all duration-300 text-lg"
                                    >
                                        <option value="geral">Geral</option>
                                        <option value="sa√∫de">Sa√∫de</option>
                                        <option value="higiene">Higiene</option>
                                        <option value="educa√ß√£o">Educa√ß√£o</option>
                                        <option value="alimenta√ß√£o">Alimenta√ß√£o</option>
                                        <option value="responsabilidade">Responsabilidade</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Enhanced Activity Suggestions -->
                            <div class="border-t border-gray-200 pt-6">
                                <p class="font-medium text-gray-700 mb-4">üí° Sugest√µes r√°pidas (8 atividades padr√£o):</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-48 overflow-y-auto">
                                    ${defaultActivities.map(activity => `
                                        <button
                                            onclick="fillActivitySuggestion('${activity.name}', '${activity.description}', ${activity.points}, '${activity.category}')"
                                            class="text-left p-3 bg-gray-50 hover:bg-blue-50 rounded-xl border border-gray-200 hover:border-blue-300 transition-all duration-300 touch-feedback"
                                        >
                                            <div class="font-medium text-gray-800">${activity.name}</div>
                                            <div class="text-sm text-gray-600 mt-1">${activity.description}</div>
                                            <div class="flex items-center justify-between mt-2">
                                                <span class="text-xs font-medium text-blue-600">${activity.category}</span>
                                                <span class="text-sm font-bold text-yellow-600">‚ö° ${activity.points} XP</span>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="flex space-x-4 pt-4">
                                <button
                                    onclick="addActivity()"
                                    class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-xl font-bold text-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-300 touch-feedback shadow-lg ${
                                        childUsers.length === 0 ? 'opacity-50 cursor-not-allowed' : ''
                                    }"
                                    ${childUsers.length === 0 ? 'disabled' : ''}
                                >
                                    ‚ûï Adicionar
                                </button>
                                <button
                                    onclick="hideAddActivityModal()"
                                    class="flex-1 bg-gray-500 text-white p-4 rounded-xl font-bold text-lg hover:bg-gray-600 transition-all duration-300 touch-feedback shadow-lg"
                                >
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Global function assignments
        window.handleLogin = handleLogin;
        window.selectUserType = selectUserType;
        window.selectMascot = selectMascot;
        window.logout = logout;
        window.completeActivity = completeActivity;
        window.showAddActivityModal = showAddActivityModal;
        window.hideAddActivityModal = hideAddActivityModal;
        window.addActivity = addActivity;
        window.fillActivitySuggestion = fillActivitySuggestion;
        window.toggleEditMode = toggleEditMode;
        window.editActivity = editActivity;
        window.deleteActivity = deleteActivity;

        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Check device capabilities
                console.log('Capacidades do dispositivo:', deviceCaps);
                
                // Load data
                const loadSuccess = loadFromLocalStorage();
                if (!loadSuccess) {
                    console.log('Primeira execu√ß√£o ou dados n√£o encontrados');
                }
                
                // Initial render
                render();
                
                // Performance monitoring
                if (window.performance && window.performance.mark) {
                    window.performance.mark('app-ready');
                }
                
                // Show welcome message for first-time users
                if (appState.users.length === 0) {
                    setTimeout(() => {
                        showNotification('Bem-vindo ao SuperKids! üéâ', 'info', 6000);
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-red-400 to-pink-500 flex items-center justify-center p-4">
                        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                            <div class="text-6xl mb-4">üòµ</div>
                            <h1 class="text-2xl font-bold text-red-600 mb-4">Oops! Algo deu errado</h1>
                            <p class="text-gray-600 mb-6">N√£o foi poss√≠vel inicializar a aplica√ß√£o.</p>
                            <button 
                                onclick="location.reload()" 
                                class="bg-blue-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 transition-colors touch-feedback"
                            >
                                üîÑ Tentar novamente
                            </button>
                        </div>
                    </div>
                `;
            }
        });

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('Erro global:', e);
            showNotification('Ocorreu um erro inesperado', 'error');
        });

        // Enhanced unload handling
        window.addEventListener('beforeunload', function() {
            saveToLocalStorage();
        });

        // Prevent zoom on double-tap for better iPad experience
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Add haptic feedback for iOS
        if (deviceCaps.isIOS && 'ontouchstart' in window) {
            document.addEventListener('touchstart', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    vibrateDevice(50);
                }
            });
        }

    </script>
</body>
</html>
